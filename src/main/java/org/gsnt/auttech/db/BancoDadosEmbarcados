/* banco dados empresa embarcado */
/* ok */
CREATE DATABASE bancoempresa
    WITH
    OWNER = gilberto
    ENCODING = 'UTF8'
    LC_COLLATE = 'pt_BR.UTF-8'
    LC_CTYPE = 'pt_BR.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1
    IS_TEMPLATE = False;

GRANT TEMPORARY, CONNECT ON DATABASE bancoempresa TO PUBLIC;

GRANT ALL ON DATABASE bancoempresa TO gilberto;



/* >>>>> tabela inicial <<<<< */

/* ok */

CREATE TABLE public.tabRegistro
(
    cod integer NOT NULL,
    cnpj character varying(14),
    cpf character varying(11),
    "Nome" character varying(180),
    fantasia character varying(180),
    PRIMARY KEY (cod)
);

ALTER TABLE IF EXISTS public.cnpj
    OWNER to gilberto;



/* >>>>> Tabela Cliente <<<<< */

/* ok */

CREATE SEQUENCE IF NOT EXISTS public.sqcodcliente
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodcliente
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabcliente
(
   	cod bigint NOT NULL DEFAULT nextval('sqcodcliente'::regclass),
    	tipo boolean NOT NULL DEFAULT false,
	cnpf character varying(19),
	cpf character varying(15),
	inscr character varying(15),
	inscrest character varying(15),
	rg character varying(15),
  	nome character varying(180) NOT NULL,
	apelido character varying(180),
	dataini date,
	datacad date,
	perfil Boolean NOT NULL,
    	status boolean NOT NULL DEFAULT true,
    CONSTRAINT tabcliente_pkey PRIMARY KEY (cod)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabcliente
    OWNER to "gilberto";


/* >>>>> Tabela Telefone Cliente <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqcodtelefone
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodtelefone
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabtelefone
(
    cod bigint NOT NULL DEFAULT nextval('sqcodtelefone'::regclass),
    codexterno bigint NOT null,
	codcaso int NOT null,
	tipo int NOT NULL,
	numerotel character varying(15),
	CONSTRAINT tabtelefone_pkey PRIMARY KEY (cod)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabtelefone
    OWNER to "gilberto";


CREATE INDEX idx_tabcliente_cpf   ON tabcliente (cpf);

CREATE INDEX idx_tabcliente_cnpj  ON tabcliente (cnpj);



/* >>>>> Tabela email Cliente <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqemail
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqemail
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabemail
(
    cod bigint NOT NULL DEFAULT nextval('sqemail'::regclass),
    codexterno bigint NOT null,
	codcaso int NOT null,
	tipo int NOT NULL,
	email character varying(150),
	CONSTRAINT tabemail_pkey PRIMARY KEY (cod)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabemail
    OWNER to "gilberto";




/* >>>>> Tabela endereço Cliente <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqcodendereco
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodendereco
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabendereco
(
        cod bigint NOT NULL DEFAULT nextval('sqcodendereco'::regclass),
	codexterno bigint NOT null,
	codcaso int NOT null,
	tipoend int NOT null,
	endereco character varying(150),
	numero  character varying(10),
	bairro character varying(80),
	cidade character varying(80),
	estado int,
        complemento character varying(150),
	cep character varying(10),
	CONSTRAINT tabendereco_pkey PRIMARY KEY (cod)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabenderco
    OWNER to "gilberto";



/* >>>>> Tabela Veículo <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqcodveiculo
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodveiculo
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabveiculo
(
    cod bigint NOT NULL DEFAULT nextval('sqcodveiculo'::regclass),
	placa character varying(8) NOT NULL,
	marca int,
	modelo int,
	chassi  character varying(20),
	motor character varying(20),
	cv character varying(5),
	turbo boolean DEFAULT false,
	emlinha boolean DEFAULT false,
	emv boolean DEFAULT false,
	anof character varying(4),
	anom character varying(4),
	revavan character varying(12),
	arquente boolean DEFAULT false,
	airbag boolean DEFAULT false,
	freioabs boolean DEFAULT false,
	alarme boolean DEFAULT false,
	arcond boolean DEFAULT false,
	controletracao boolean DEFAULT false
	dirhid boolean DEFAULT false,
	direlet boolean DEFAULT false,
	vidroelet boolean DEFAULT false,
	travaelet boolean DEFAULT false,
	tracao4 boolean DEFAULT false,
	teto boolean DEFAULT false,
	CONSTRAINT tabveiculo_pkey PRIMARY KEY (cod)

)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabveiculo
    OWNER to "gilberto";



/* >>>>> Tabela veículo Cliente <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqcodveiccliente
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodveiccliente
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabveiccliente
(
    cod bigint NOT NULL DEFAULT nextval('sqcodveiccliente'::regclass),
    codcliente bigint NOT null,
	codveiculo bigint NOT NULL,
	CONSTRAINT tabveiccliente_pkey PRIMARY KEY (cod)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabveiccliente
    OWNER to "gilberto";

ALTER TABLE IF EXISTS public.tabveiccliente
    ADD CONSTRAINT fkveiccliente FOREIGN KEY (codcliente)
    REFERENCES public.tabcliente (cod) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;

ALTER TABLE IF EXISTS public.tabveiccliente
    ADD CONSTRAINT fkveicclientes FOREIGN KEY (codveiculo)
    REFERENCES public.tabveiculo (cod) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;



/* >>>>> Tabela OS <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqcodos
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodos
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabos
(
    cod bigint NOT NULL DEFAULT nextval('sqcodoscliente'::regclass),
    codcliente bigint NOT NULL,
    codveiculo bigint NOT NULL,
    vtpecas real,
    vtservicos real,
    vtos real,
    asslevas boolean DEFAULT false,
    obsos text COLLATE pg_catalog."default",
    statusos integer,
    orcamento boolean DEFAULT false,
    dataabertura character varying COLLATE pg_catalog."default",
    datafechamento character varying COLLATE pg_catalog."default",
    horaabertura character varying COLLATE pg_catalog."default",
    horafechamento character varying COLLATE pg_catalog."default",
    CONSTRAINT taboscliente_pkey PRIMARY KEY (cod)
)


TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabos
    OWNER to gilberto;

ALTER TABLE IF EXISTS public.tabos
    ADD CONSTRAINT fkoscliente FOREIGN KEY (codcliente)
    REFERENCES public.tabcliente (cod) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;

ALTER TABLE IF EXISTS public.tabos
    ADD CONSTRAINT fkosclientes FOREIGN KEY (codveiculo)
    REFERENCES public.tabveiculo (cod) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;



/* >>>>> Tabela Orçamento cliente <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqcodor
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodorcliente
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabor
(
    cod bigint NOT NULL DEFAULT nextval('sqcodorcliente'::regclass),
    codcliente bigint NOT NULL,
    codveiculo bigint NOT NULL,
    vtpecas integer,
    vtservicos integer,
    vtos integer,
    stgeralorcamento integer,
    respcliente integer,
    datarespcliente character varying COLLATE pg_catalog."default",
    horarespcliente character varying COLLATE pg_catalog."default",
    formarespcliente integer,
    resptecmecanico integer,
    respteceletrico integer,
    resptecinjecao integer,
    resptecpneu integer,
    respteccambio integer,
    resptecmotor integer,
    dataabertura character varying COLLATE pg_catalog."default",
    datafechamento character varying COLLATE pg_catalog."default",
    horafechamento character varying COLLATE pg_catalog."default",
    codos bigint,
    digitoor integer,
    CONSTRAINT taborcliente_pkey PRIMARY KEY (cod),
    CONSTRAINT fkorcliente FOREIGN KEY (codcliente)
        REFERENCES public.tabcliente (cod) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
        NOT VALID,
    CONSTRAINT fkorclientes FOREIGN KEY (codveiculo)
        REFERENCES public.tabveiculo (cod) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
        NOT VALID
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabor
    OWNER to gilberto;


>>>>> Tabela peças Os <<<<<

>>>>> Tabela serviços Os <<<<<

>>>>> Tabela peças Or <<<<<

>>>>> Tabela serviços Or <<<<<

/* >>>>> Tabela Agenda <<<<< */


CREATE SEQUENCE IF NOT EXISTS public.sqcodagenda
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodagenda
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabagenda
(
    cod bigint NOT NULL DEFAULT nextval('sqcodagenda'::regclass),
	dataagenda character varying(11) NOT NULL,
	hora character varying(5) NOT NULL,
	nome character varying(150) NOT NULL,
	veiculo character varying(100) NOT NULL,
	placa character varying(8) NOT NULL,
	telefone character varying(20) NOT NULL,
	obs text,
	revisao boolean DEFAULT false,
	suspensao boolean DEFAULT false,
	injecao boolean DEFAULT false,
	pneus boolean DEFAULT false,
	trocaoleo boolean DEFAULT false,
	freio boolean DEFAULT false,
	eletrico boolean DEFAULT false,
	mecanico boolean DEFAULT false,
	motor boolean DEFAULT false,
	caixa boolean DEFAULT false,
	socmecanico boolean DEFAULT false,
	soceletrico boolean DEFAULT false,
	asslevas boolean DEFAULT false,
	assguincho boolean DEFAULT false,
	assbuscar boolean DEFAULT false,
	assclientetraz boolean DEFAULT false,
	assenvioguincho Boolean DEFAULT false,
        assenviodeslocamento Boolean DEFAULT false,
 	CONSTRAINT tabagenda_pkey PRIMARY KEY (cod)

)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabagenda
    OWNER to "gilberto";



/* >>>>> tabela funcionários <<<<< */

CREATE SEQUENCE IF NOT EXISTS public.sqcodfuncionario
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodfuncionario
    OWNER TO gilberto;

	CREATE TABLE IF NOT EXISTS public.tabfuncionario
(
    cod bigint NOT NULL DEFAULT nextval('sqcodfuncionario'::regclass),
    cpf character varying(15) COLLATE pg_catalog."default",
    rg character varying(15) COLLATE pg_catalog."default",
    nome character varying(180) COLLATE pg_catalog."default" NOT NULL,
    apelido character varying(60) NOT NULL,
    genero boolean DEFAULT false,
    status boolean DEFAULT false,
    tipo integer,
    telefone character varying(15) COLLATE pg_catalog."default",
    telefoneconjuge character varying(15) COLLATE pg_catalog."default",
    mae character varying(180) COLLATE pg_catalog."default",
    pai character varying(180) COLLATE pg_catalog."default",
    conjuge character varying(180) COLLATE pg_catalog."default",
    qtdfilhos integer,
    obs text COLLATE pg_catalog."default",
    cartprofissional character varying(15) COLLATE pg_catalog."default",
    cargo character varying(180) COLLATE pg_catalog."default",
    funcao character varying(180) COLLATE pg_catalog."default",
    comissao boolean DEFAULT false,
    obsprof text COLLATE pg_catalog."default",
    caixamec boolean DEFAULT false,
    caixaaut boolean DEFAULT false,
    eletrica boolean DEFAULT false,
    freio boolean DEFAULT false,
    injdiesel boolean DEFAULT false,
    injflex boolean DEFAULT false,
    motordiesel boolean DEFAULT false,
    motorflex boolean DEFAULT false,
    pneus boolean DEFAULT false,
    suspensao boolean DEFAULT false,
    socorro boolean DEFAULT false,
    veiceletrico boolean DEFAULT false,
    motleva boolean DEFAULT false,
    motguincho boolean DEFAULT false,
    datanasc character varying(11) COLLATE pg_catalog."default",
    dataadm character varying(11) COLLATE pg_catalog."default",
    datadesl character varying(11) COLLATE pg_catalog."default",
    dataemissao character varying(11) COLLATE pg_catalog."default",
    comissaopecas character varying(10) COLLATE pg_catalog."default",
    comissaoservicos character varying(10) COLLATE pg_catalog."default",
    salario character varying(12) COLLATE pg_catalog."default",
    trocaoleo boolean DEFAULT false,
    CONSTRAINT tabfuncionario_pkey PRIMARY KEY (cod)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabfuncionario
    OWNER to gilberto;



/* >>>> Tabela status atendimento <<<< */


CREATE SEQUENCE IF NOT EXISTS public.sqcodstatusatendimento
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodstatusatendimento
    OWNER TO "gilberto";

CREATE TABLE IF NOT EXISTS public.tabstatusatendimento
(
    cod bigint NOT NULL DEFAULT nextval('sqcodstatusatendimento'::regclass),
    codos bigint,
    codorcamento bigint,
    codveiculo bigint NOT NULL,
    eletrico integer DEFAULT 0,
    injecao integer DEFAULT 0,
    caixa integer DEFAULT 0,
    freiodt integer DEFAULT 0,
    freiotr integer DEFAULT 0,
    motor integer DEFAULT 0,
    revisao integer DEFAULT 0,
    suspensaodt integer DEFAULT 0,
    suspensaotr integer DEFAULT 0,
    pneus integer DEFAULT 0,
    trocaoleo integer DEFAULT 0,
    lavacao integer DEFAULT 0,
    asslevar integer DEFAULT 0,
    orcambio integer DEFAULT 0,
    oreletrico integer DEFAULT 0,
    ormotor integer DEFAULT 0,
    orinjecao integer DEFAULT 0,
    ormecanica integer DEFAULT 0,
    orpneu integer DEFAULT 0,
    orstcliente integer DEFAULT 0,
    ormontagem integer DEFAULT 0,
    staviso boolean DEFAULT false,
    stgeralatend integer DEFAULT 0,
    alinbalan integer DEFAULT 0,
    dtprvzntrg character varying(10) COLLATE pg_catalog."default",   /* (data prevista para a entrega) */
    hrprvztrg character varying(10) COLLATE pg_catalog."default"     /* (hora prevista para a entrega) */
)


TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabstatusatendimento
    OWNER to gilberto;


/* tabela de contagem de ocupação do profissional */


CREATE SEQUENCE IF NOT EXISTS public.sqcodocupprfssnl
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807
    CACHE 1;

ALTER SEQUENCE public.sqcodocupprssnl
    OWNER TO "gilberto";

CREATE TABLE public.tbocupcprfssnl
(
    cod bigint NOT NULL DEFAULT nextval('sqcodocupprfssnl'::regclass),
    codprof bigint NOT NULL,
    placa character varying NOT NULL,
    tmpprvst character varying(4), /*tempo previsto*/
    rdmtndmnt integer NOT NULL; /*ordem de atedimento*/
    PRIMARY KEY (cod)
);

ALTER TABLE IF EXISTS public.tbocupcprfssnl
    OWNER to gilberto;

ALTER TABLE IF EXISTS public.tbocupcprfssnl
    ADD COLUMN aceito boolean DEFAULT false;




/* tabela histórico de profissionais / os */

CREATE SEQUENCE public.sqcodosprfssnl
    INCREMENT 1
    START 1
    MINVALUE 1
    MAXVALUE 9223372036854775807;

ALTER SEQUENCE public.sqcodosprfssnl
    OWNER TO gilberto;


correção tabela status

movimento = 0 - direcionamento, 1 - aceito, 2 - recusa, 3 - redirecionamento, 4 - inicio analise, 5 - fim analise,
            6 - Aguardando a liberação 7 - inicio serviço, 8 - fim serviço

serviço =  0 - Todos 8 - alinhamento, 9 - Balancemaneto, 4 - caixa de câmbio, 6 - freio, 7 - motor,
           5 - suspensão, 1 - troca de óleo, 10 - pneu,
           3 - eletrico, 2 - injeção eletronica

tipo = a - ordem serviço, b - Orçamento, c - termino, d - entrega


CREATE TABLE IF NOT EXISTS public.tabosprfssnl
(
    cod bigint NOT NULL DEFAULT nextval('sqcodosprfssnl'::regclass),
    codos bigint NOT NULL,
    prof bigint NOT NULL,
    horastrabalhadas numeric DEFAULT 0,
    tipo character(2) COLLATE pg_catalog."default",
    movimento integer,
    dtmovimento date DEFAULT CURRENT_DATE,
    hrmovimento time without time zone DEFAULT CURRENT_TIME,
    servico integer,
    CONSTRAINT tabosprfssnl_pkey PRIMARY KEY (cod)
)


TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.tabosprfssnl
    OWNER to gilberto;









/* prodecures   */

--------- procedures relacionadas a tabela tabosprfssnl(os x profissional) os

Inserção

CREATE OR REPLACE PROCEDURE public.ins_tabosprfssnl(
	IN p_codos bigint,
	IN p_servico integer,
	IN p_prof bigint,
	IN p_horastrabalhadas numeric,
	IN p_tipo character,
	IN p_movimento integer)
LANGUAGE 'plpgsql'
AS $BODY$
BEGIN
    INSERT INTO public.tabosprfssnl (
        codos,
        servico,
        prof,
        horastrabalhadas,
        tipo,
        movimento,
        dtmovimento,
        hrmovimento
    )
    VALUES (
        p_codos,
        p_servico,
        p_prof,
        COALESCE(p_horastrabalhadas, 0),
        p_tipo,
        p_movimento,
        CURRENT_DATE,     -- data do servidor
        CURRENT_TIME      -- hora do servidor
    );
END;
$BODY$;
ALTER PROCEDURE public.ins_tabosprfssnl(bigint, integer, bigint, numeric, character, integer)
    OWNER TO gilberto;



----------   procedures relacionadas a tebela statusantendimento interna

update

CREATE OR REPLACE PROCEDURE public.upd_tabstatusatendimento(
    IN p_cod BIGINT,
    IN p_codorcamento BIGINT,
    IN p_eletrico INTEGER,
    IN p_injecao INTEGER,
    IN p_caixa INTEGER,
    IN p_freiodt INTEGER,
    IN p_freiotr INTEGER,
    IN p_motor INTEGER,
    IN p_revisao INTEGER,
    IN p_suspensaodt INTEGER,
    IN p_suspensaotr INTEGER,
    IN p_pneus INTEGER,
    IN p_trocaoleo INTEGER,
    IN p_lavacao INTEGER,
    IN p_asslevar INTEGER,
    IN p_orcambio INTEGER,
    IN p_oreletrico INTEGER,
    IN p_ormotor INTEGER,
    IN p_orinjecao INTEGER,
    IN p_ormecanica INTEGER,
    IN p_orpneu INTEGER,
    IN p_orstcliente INTEGER,
    IN p_ormontagem INTEGER,
    IN p_staviso BOOLEAN,
    IN p_stgeralatend INTEGER,
    IN p_alinbalan INTEGER,
    IN p_dtprvzntrg VARCHAR(10),
    IN p_hrprvztrg VARCHAR(10)
)
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE public.tabstatusatendimento
    SET
        codos          = p_codos,
        codorcamento   = p_codorcamento,
        eletrico       = p_eletrico,
        injecao        = p_injecao,
        caixa          = p_caixa,
        freiodt        = p_freiodt,
        freiotr        = p_freiotr,
        motor          = p_motor,
        revisao        = p_revisao,
        suspensaodt    = p_suspensaodt,
        suspensaotr    = p_suspensaotr,
        pneus          = p_pneus,
        trocaoleo      = p_trocaoleo,
        lavacao        = p_lavacao,
        asslevar       = p_asslevar,
        orcambio       = p_orcambio,
        oreletrico     = p_oreletrico,
        ormotor        = p_ormotor,
        orinjecao      = p_orinjecao,
        ormecanica     = p_ormecanica,
        orpneu         = p_orpneu,
        orstcliente    = p_orstcliente,
        ormontagem     = p_ormontagem,
        staviso        = p_staviso,
        stgeralatend   = p_stgeralatend,
        alinbalan      = p_alinbalan,
        dtprvzntrg     = p_dtprvzntrg,
        hrprvztrg      = p_hrprvztrg
    WHERE cod = p_cod;
END;
$$

exclusão

CREATE OR REPLACE PROCEDURE public.del_statusatendimento(
    IN p_cod BIGINT
)
LANGUAGE plpgsql
AS $$
BEGIN
    DELETE FROM public.tabstatusatendimento
    WHERE cod = p_cod;
END;
$$;






/* VIEWS */



CREATE OR REPLACE VIEW public.sereminiciados
    AS
     SELECT os.cod,
    t1.placa,
    t1.modelo,
    st.eletrico,
    st.injecao,
    st.caixa,
    st.freiodt,
    st.freiotr,
    st.motor,
    st.revisao,
    st.suspensaodt,
    st.suspensaotr,
    st.pneus,
    st.trocaoleo
   FROM tabos os
     JOIN tabveiculo t1 ON t1.cod = os.codveiculo
     JOIN tabstatusatendimento st ON st.codos = os.cod
  WHERE st.stgeralatend < 8
  ORDER BY os.cod ;




CREATE OR REPLACE VIEW public.statussereminiciados
    AS
     SELECT os.cod,
    t1.placa,
    t1.modelo,
    st.eletrico,
    st.injecao,
    st.caixa,
    st.freiodt,
    st.freiotr,
    st.motor,
    st.revisao,
    st.suspensaodt,
    st.suspensaotr,
    st.pneus,
    st.trocaoleo
   FROM tabos os
     JOIN tabveiculo t1 ON t1.cod = os.codveiculo
     JOIN tabstatusatendimento st ON st.codos = os.cod
  WHERE st.stgeralatend < 8
  ORDER BY os.cod ;



CREATE OR REPLACE VIEW public.statusorcamento
    AS
     SELECT st.codveiculo,
    t1.placa,
    t1.modelo,
    st.orcambio,
    st.oreletrico,
    st.ormotor,
    st.orinjecao,
    st.ormecanica,
    st.orpneu,
    st.orstcliente,
    st.ormontagem
   FROM tabstatusatendimento st
     JOIN tabveiculo t1 ON t1.cod = st.codveiculo
  WHERE st.stgeralatend < 5
  ORDER BY st.cod ;


  // consulta para tela de serviços / tempo por profissional

  CREATE OR REPLACE VIEW public.nmsrvcprfssnl
   AS
   SELECT fn.apelido,
      count(pf.placa) AS total
     FROM tbocupcprfssnl pf
       JOIN tabfuncionario fn ON fn.cod = pf.codprof
    GROUP BY fn.cod, fn.apelido
    ORDER BY (count(pf.placa));

  ALTER TABLE public.nmsrvcprfssnl
      OWNER TO gilberto;



  //consulta statusgeralpublico

  CREATE VIEW public.statusgeralpublico
   AS
  select * from public.tbtstgrlpblc where ativo = 'true';

  ALTER TABLE public.statusgeralpublico
      OWNER TO gilberto;


------- Funções

  //Função retorna(lista) a ocupação por profissional

  CREATE FUNCTION public.cpcprfssnl(IN codprof1 bigint)
      RETURNS TABLE(placa varchar, tempo varchar, ordem int, aceito boolean )
      LANGUAGE 'plpgsql'

  AS $BODY$
 BEGIN
 RETURN QUERY
 SELECT
 t.placa,
 t.tmpprvst as tempo,
 t.rdmtndmnt as ordem,
 t.aceito as aceito
 from tbocupcprfssnl t
 where t.codprof = codprof1
 order by t.rdmtndmnt;
 END;
  $BODY$;

  ALTER FUNCTION public.cpcprfssnl(bigint)
      OWNER TO gilberto;


    // função para o accordion agenda

CREATE OR REPLACE VIEW public.gnd
 AS
 SELECT *
   FROM tabagenda
  ORDER BY tabagenda.dataagenda, tabagenda.hora;

ALTER TABLE public.gnd
    OWNER TO gilberto;

GRANT ALL ON TABLE public.gnd TO gilberto WITH GRANT OPTION;
GRANT SELECT ON TABLE public.gnd TO usuario_base;

sequencia de procedures e functions para gravar um vez só o direcionamento e a ocupação

Function para ver quantos atendimentos o prof. já tem

CREATE OR REPLACE FUNCTION public.fn_qtde_tbocupcprfssnl_por_codprof(
    p_codprof integer
)
RETURNS integer
LANGUAGE plpgsql
AS $$
DECLARE
    v_qtde integer;
BEGIN
    SELECT COUNT(*)::integer
    INTO v_qtde
    FROM public.tbocupcprfssnl
    WHERE codprof = p_codprof;

    RETURN v_qtde;
END;
$$;

retorna a placa pelo cód do veículo

CREATE OR REPLACE FUNCTION public.fn_busca_placa_por_cod(
    p_cod bigint
)
RETURNS varchar
LANGUAGE sql
AS $$
    SELECT placa
    FROM public.tabveiculo
    WHERE cod = (
        SELECT codveiculo
        FROM public.tabos
        WHERE cod = p_cod
    );
$$;

crie uma procedure que irá inserir um registro na tabela tbocupcprfssnl nos campos codprof Bigint, placa varchar e no rdmtndmnt integer onde ela receberá como parâmento um integer para o codprof e um integer para o campo placa sendo que no campo placa ela deverá chamar a function public.fn_busca_placa_por_cod para chegar ao varchar e no campo rdmtndmnt deverá chamar a function public.fn_qtde_tbocupcprfssnl_por_codprof e somar mais 1 para inserir

CREATE OR REPLACE PROCEDURE public.prc_inserir_tbocupcprfssnl(
    p_codprof bigint,
    p_placa_cod bigint
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_placa varchar;
    v_rdmtndmnt integer;
BEGIN
    -- Busca a placa
    v_placa := public.fn_busca_placa_por_cod(p_placa_cod);

    -- Calcula o rdmtndmnt somando 1 à quantidade atual
    v_rdmtndmnt := public.fn_qtde_tbocupcprfssnl_por_codprof(p_codprof) + 1;

    -- Insere o registro
    INSERT INTO public.tbocupcprfssnl(codprof, placa, rdmtndmnt)
    VALUES (p_codprof, v_placa, v_rdmtndmnt);

END;
$$;